version: "{build}"

cache:
  - '%LocalAppData%\NuGet\Cache -> **\Rustic*.csproj'
  - '%LocalAppData%\NuGet\v3-cache  -> **\Rustic*.csproj'
  - C:\ProgramData\chocolatey\bin -> appveyor.yml
  - C:\ProgramData\chocolatey\lib -> appveyor.yml

environment:
  COVERALLS_REPO_TOKEN: # Encrypted coveralls repository token
    secure: cLqzCAz4DJr0yy9SudBhqMP18FGcZJb9Lzojw8xeog4T+mZ2m9CNwmRQfaxYmuc5

os: Visual Studio 2022

install:
  # SDK version fix
  - cinst dotnet-sdk --version 6.0.101

artifacts:
  - path: "./tests/**/coverage*.xml"
  - path: "./src/**/Rustic.*.nupkg"

before_build:
  - ps: $Env:LABEL = if ($Env:APPVEYOR) { "${Env:APPVEYOR_BUILD_NUMBER.PadLeft(5, "0")}-${Env:APPVEYOR_REPO_BRANCH}" } else { "local" }
  - ps: $Env:DOTNET_CLI_TELEMETRY_OPTOUT=1
  - ps: $Env:DOTNET_NOLOGO=1
  - ps: dotnet restore -verbosity:q

build_script:
  - ps: ./scripts/build.ps1

test_script:
  - ps: ./scripts/test.ps1

for:
  - branches: # Only pack and deploy nuget packages for releases
      only:
        - /release-/
    build_script:
      - ps: ./scripts/build-release.ps1

    deploy:
      - provider: NuGet # Nuget.org
        api_key:
          secure: wB/TicV9Qsuqfs1X3excsY/wt/pBfqQDb/9kKFWQcCHTL0rQZNHaVqDiEWQ39U6L
        artifact: /.*(\.|\.s)nupkg/
        on:
          branch: /release-/
      - provider: NuGet # Github packages
        server: https://nuget.pkg.github.com/ProphetLamb/index.json
        artifact: /.*\.nupkg/
        username: ProphetLamb
        api_key:
          secure: C8xC+nv4MSirvCA8kUoan4sz2B8aFaytWW2m4lrLqXhAnSkOmo6fN90QHiGJoSGI
        on:
          branch: /release-/
